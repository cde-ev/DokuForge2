\NeedsTeXFormat{LaTeX2e}%
  [1995/12/01]
\ProvidesPackage{tokparse}%
  [2004/11/09 Parsing Token Delimited Arguments]

\let\@EA\expandafter

\def\@namelet#1%
  {\expandafter\let\csname#1\endcsname}

\def\pt@appendtoks%
  {\pt@doappendtoks\relax} % FIXME braces handled correctly, but ugly ...
\def\pt@doappendtoks#1\to#2%
  {\expandafter\expandafter\expandafter#2%
   \expandafter\expandafter\expandafter{%
   \expandafter\expandafter\the\expandafter#2\@gobble#1}}

\def\pt@firstoffour #1#2#3#4{#1}
\def\pt@secondoffour#1#2#3#4{#2}
\def\pt@thirdoffour #1#2#3#4{#3}
\def\pt@fourthoffour#1#2#3#4{#4}

\def\pt@installhandler#1#2#3%
  {\@namelet{#2.\string#3}#1\@namedef{#2 \string#3}}
\def\pt@call#1#2%
  {\@nameuse{#1 \string#2}}

\def\ptHandler     {\pt@installhandler\pt@firstoffour }
\def\ptNoargHandler{\pt@installhandler\pt@secondoffour}
\def\ptEndHandler  {\pt@installhandler\pt@thirdoffour }


\def\pt@dispatch#1#2% prefix obj ifhander ifnoarg ifend ifother
  {\@ifundefined{#1.\string#2}%
     {\pt@fourthoffour       }%
     {\@nameuse{#1.\string#2}}}

\def\processtagged#1\upto#2\then#3%
  {\ptEndHandler{#1}{#2}{}% FIXME FIXME restore?!?!?
   \def\pt@prefix{#1}\def\pt@atend{#3}%
   \pt@afterblanks\pt@command}


% skip blanks and pars, then insert tokens #1

\def\pt@afterblanks#1%
  {\def\pt@ab@cmd{#1}\pt@ab@skip}
\def\pt@ab@skip%
  {\futurelet\nextchar\pt@ab@dispatch}
\def\pt@ab@dispatch%
  {\ifx\nextchar\pt@blankspace
     \def\\ {\pt@ab@skip}%
   \else\ifx\nextchar\par%
     \long\def\\##1{\pt@ab@skip}%
   \else
     \let\\\pt@ab@cmd
   \fi\fi
   \\}

% remember one command, then accumulate argument

\def\pt@command#1%
  {\pt@dispatch\pt@prefix{#1}%
    {\pt@witharg{\pt@execcmd#1}}%
    {\pt@call\pt@prefix{#1}\pt@afterblanks\pt@command}%
    {\pt@call\pt@prefix{#1}\pt@atend}%
    {\message{Garbage before first header}}}
    
\def\pt@execcmd#1#2%
  {\pt@call\pt@prefix{#1}{#2}%
   \pt@afterblanks\pt@command}

% accumulate argument

\newtoks\pt@wa@arg

{\def\\{\global\let\pt@blankspace= }\\ }%

\def\pt@witharg#1%
  {\def\pt@wa@cmd{#1}%
   \pt@wa@arg{}%
   \let\pt@wa@seenblank\@empty
   \pt@afterblanks\pt@wa@accum}
\def\pt@wa@accum%
  {\futurelet\nextchar\pt@wa@dispatch}
\def\pt@wa@dispatch%
  {\ifx\nextchar\pt@blankspace
     \def\\ {\pt@wa@blank}%
   \else\ifx\nextchar\par
     \long\def\\##1{\pt@wa@blank}%
   \else\ifx\nextchar\bgroup
     \def\\{\pt@wa@group}%
   \else
     \def\\{\pt@wa@other}%
   \fi\fi\fi
   \\}

\def\pt@wa@blank%
  {\def\pt@wa@seenblank{ }\pt@wa@accum}
\def\pt@wa@doappend#1%
  {\@EA\pt@appendtoks\pt@wa@seenblank#1\to\pt@wa@arg
   \def\pt@wa@seenblank{}\pt@wa@accum}
\def\pt@wa@group#1%
  {\pt@wa@doappend{{#1}}}

\def\pt@wa@other#1%
  {\pt@dispatch\pt@prefix{#1}%
     {\@EA\pt@wa@cmd\@EA{\the\pt@wa@arg}#1}%
     {\@EA\pt@wa@cmd\@EA{\the\pt@wa@arg}#1}%
     {\@EA\pt@wa@cmd\@EA{\the\pt@wa@arg}#1}%
     {\pt@wa@doappend{#1}}}

\endinput
