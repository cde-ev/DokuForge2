\NeedsTeXFormat{LaTeX2e}%
  [1995/12/01]
\ProvidesPackage{abbildung}%
  [2004/11/08 Einfaches Einfügen von Abbildungen]

\RequirePackage{graphicx}
\RequirePackage{tokparse}

%%% 

%   \abbildung{...}
%
% und
%
%   \begin{abbildung} ... \end{abbildung}
%
% sind äquivalent. Eine Abbildung wird definiert durch
%
%   \abbildung{ name \scaled 0.7 : Das ist die Bildunterschrift }
%
% liest die Abbildung kursXX/fig_XX_name, setzt das label fig_XX_name und
% vergibt die Bildunterschrift "Das ist die Bildunterschrift". Letztere
% ist optional, die Suffixe
%
%   \width      <length>     Bild kriegt Breite <length>
%   \scaledtotw <factor>     wie \width <factor>\textwidth
%   \scaled     <factor>     Bild wird mit dem Faktor <factor> skaliert
%   \labelled   <label>      statt fig_XX_name wird <label> gesetzt
%
% modifizieren das vorstehende Bild. Die Bildunterschrift ist optional
% (dann werden auch keine Labels gesetzt). Mehrere Abbildungen können
% durch
% 
%   \abbildung{ eins \scaled 0.3, zwei \scaled 0.5: Bildunterschrift }
%
% nebeneinander gesetzt werden, der Abstand ist defaultmäßig 1cm, kann
% aber mit
%
%   \withspace <length>
%
% geändert werden.
%
% Es gibt eine Variante abbildung*, die genauso funktioniert, aber einen
% anderen Pfad durchsucht und andere Labels vergibt.

\def\ab@arabic#1%
  {\ifnum\the\value{#1}<10 0\fi\the\value{#1}}

\def\abbildungpictureprefix    #1{kurs\ab@arabic{chapter}/fig_\ab@arabic{chapter}_#1}
\def\abbildunglabelprefix      #1{fig_\ab@arabic{chapter}_#1}
\def\abbildungstarpictureprefix#1{images/#1}
\def\abbildungstarlabelprefix  #1{image_#1}
\def\abbildungdefaultborder{1cm}

%%%

\newif\if@abbildungstarred

\def\@@abbildung{abbildung}
\def\ab@cmd@{ab@cmd@}
\def\ab@cap@{ab@cap@}

\def\ab@appendtoks@expanded%
  {\ab@doappendtoks@expanded\relax} % TeX strips braces around arguments ...
\def\ab@doappendtoks@expanded#1\to#2%
  {\toks@\expandafter{#2}\edef#2{\the\toks@\@gobble#1}}

\def\abbildung
  {\ifx\@currenvir\@@abbildung
     \@abbildungstarredfalse
     \expandafter\ab@getenv
   \else
     \expandafter\ab@getarg
   \fi}
\@namedef{abbildung*}%
  {\@abbildungstarredtrue\ab@getenv}
\def\ab@getenv#1\end%
  {\ab@iterate,#1\ab@end\ab@capend\end}
\def\ab@getarg%
  {\@ifstar%
     {\@abbildungstarredtrue \ab@dogetarg}%
     {\@abbildungstarredfalse\ab@dogetarg}}
\def\ab@dogetarg#1%
  {\ab@iterate,#1\ab@end\ab@capend}


\def\ab@iterate%
  {\bgroup\processtagged\ab@cmd@\upto\ab@end\then\ab@getcaption}

\let\ab@clauses\@empty
\let\ab@labels\@empty
\let\ab@cur@label\@empty

\def\ab@register@entry%
  {\ifx\ab@cur@label\@empty\else
     \ab@appendtoks@expanded
       \noexpand\ab@produce{\ab@cur@picture}{\ab@cur@width}{\ab@cur@spacer}%
     \to\ab@clauses
     \ab@appendtoks@expanded
       \noexpand\label{\ab@cur@label}%
     \to\ab@labels
   \fi}

\ptHandler\ab@cmd@,#1%
  {\ab@register@entry
   \if@abbildungstarred
     \def\ab@cur@label  {\abbildungstarlabelprefix{#1}}%
     \def\ab@cur@picture{\abbildungstarpictureprefix{#1}}%
   \else
     \def\ab@cur@label  {\abbildunglabelprefix{#1}}%
     \def\ab@cur@picture{\abbildungpictureprefix{#1}}%
   \fi
   \let\ab@cur@spacer \abbildungdefaultborder
   \let\ab@cur@width  \@empty}

\ptEndHandler\ab@cmd@:%
  {}

\ptHandler\ab@cmd@\width#1%
  {\def\ab@cur@width{[width=#1]}}
\ptHandler\ab@cmd@\scaledtotw#1%
  {\def\ab@cur@width{[width=#1\textwidth]}}
\ptHandler\ab@cmd@\scaled#1%
  {\def\ab@cur@width{[scale=#1]}}
\ptHandler\ab@cmd@\labelled#1%
  {\def\ab@cur@label{#1}}
\ptHandler\ab@cmd@\withspace#1%
  {\def\ab@cur@spacer{#1}}

% We use processtagged because it strips whitespace

\def\ab@getcaption#1\ab@capend%
  {\ab@register@entry
   \def\reserved@a{#1}\ifx\reserved@a\@empty
     \let\ab@caption\undefined
   \else
     \processtagged\ab@cap@\upto\ab@end\then\empty
       \ab@get#1% ends in \ab@end. NB: \processtagged strips whitespace ...
   \fi\ab@producefigure}
  
\ptHandler\ab@cap@\ab@get#1%
  {\def\ab@caption{#1}}
  
\def\ab@producefigure%
  {\begin{figure}%
     \begin{center}%
       \def\ab@lastwidth{}% marker to make ab@produce skip the \hspace
       \leavevmode\hbox{\ab@clauses}%
     \end{center}%
     \ifx\ab@caption\undefined\else
       \caption{\ab@caption}
       \ab@labels
     \fi
   \end{figure}%
   \egroup}

\def\ab@produce#1#2#3%
  {\ifx\ab@lastwidth\@empty\else
     \ifdim\ab@lastwidth>#3\relax
       \hspace{\ab@lastwidth}%
     \else
       \hspace{#3}%
     \fi
   \fi
   \def\ab@lastwidth{#3}%
   \includegraphics#2{#1}}

\endinput
